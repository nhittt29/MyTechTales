{{ define "main" }}
<section class="search-page" style="padding:2rem;max-width:850px;margin:auto;">
  <h1 style="margin-bottom:1rem;">T√¨m ki·∫øm üîç</h1>
  <p>Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m trong Blog v√† Profile</p>

  <input id="search-input" type="text" placeholder="V√≠ d·ª•: m√¥i tr∆∞·ªùng runtime, JavaScript, API, Profile..."
         style="width:100%;padding:10px;border-radius:8px;border:1px solid #bbb;margin-top:10px;">
  <div id="search-results" style="margin-top:2rem;"></div>

  <script>
    // --- T·∫£i d·ªØ li·ªáu t·ª´ index.json ---
    async function loadIndex() {
      try {
        const res = await fetch('{{ "index.json" | absURL }}');
        if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i index.json");
        const data = await res.json();
        console.log("D·ªØ li·ªáu t·ª´ index.json:", data); // G·ª° l·ªói ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu
        return data;
      } catch (error) {
        console.error("L·ªói khi t·∫£i index.json:", error);
        return [];
      }
    }

    // --- H√†m c·∫Øt ƒëo·∫°n vƒÉn ch·ª©a t·ª´ kh√≥a ---
    function extractSnippet(content, keyword) {
      if (!content || typeof content !== "string") {
        return "Kh√¥ng t√¨m th·∫•y n·ªôi dung ph√π h·ª£p ƒë·ªÉ hi·ªÉn th·ªã.";
      }
      const lowerContent = content.toLowerCase();
      const lowerKeyword = keyword.toLowerCase();
      const index = lowerContent.indexOf(lowerKeyword);
      if (index === -1) {
        return content.length > 160 ? content.slice(0, 160) + "..." : content;
      }

      const start = Math.max(0, index - 80);
      const end = Math.min(content.length, index + keyword.length + 80);
      const snippet = content.slice(start, end).replace(new RegExp(`(${keyword})`, "gi"), "<mark>$1</mark>");
      return snippet + (end < content.length ? "..." : "");
    }

    // --- Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm (ph∆∞∆°ng ph√°p ch√≠nh) ---
    function renderResults(results, keyword) {
      const container = document.getElementById("search-results");
      container.innerHTML = "";

      if (results.length === 0) {
        container.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o ph√π h·ª£p.</p>";
        return;
      }

      results.forEach(post => {
        const div = document.createElement("div");
        div.style.marginBottom = "1.5rem";
        const snippet = extractSnippet(
          post.content || post.summary || post.description || "N·ªôi dung kh√¥ng kh·∫£ d·ª•ng.",
          keyword
        );
        div.innerHTML = `
          <div style="background:#fff;border:1px solid #ddd;padding:1rem;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
            <h3><a href="${post.permalink}" style="color:#0077cc;text-decoration:none;">${post.title || "Ti√™u ƒë·ªÅ kh√¥ng c√≥"}</a></h3>
            <p style="color:#444;line-height:1.6;">${snippet}</p>
            <small style="color:#666;">Ngu·ªìn: ${post.permalink.includes("/blog/") ? "Blog" : post.permalink.includes("/profile/") ? "Profile" : "Kh√°c"}</small>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // --- X·ª≠ l√Ω khi nh·∫≠p t·ª´ kh√≥a (ph∆∞∆°ng ph√°p ch√≠nh) ---
    document.addEventListener("DOMContentLoaded", async () => {
      const data = await loadIndex();
      const input = document.getElementById("search-input");

      input.addEventListener("input", e => {
        const keyword = e.target.value.trim().toLowerCase();
        if (!keyword) {
          document.getElementById("search-results").innerHTML = "";
          return;
        }

        const results = data.filter(post =>
          (post.title && post.title.toLowerCase().includes(keyword)) ||
          (post.content && post.content.toLowerCase().includes(keyword)) ||
          (post.summary && post.summary.toLowerCase().includes(keyword)) ||
          (post.description && post.description.toLowerCase().includes(keyword))
        );

        renderResults(results, keyword);
      });
    });

    // --- Ph∆∞∆°ng ph√°p b·ªï sung t·ª´ search.js ---
    const searchInputAlt = document.getElementById("search-input");
    const searchResultsAlt = document.getElementById("search-results");

    if (searchInputAlt) {
      let pages = [];

      // ‚úÖ ƒê·∫£m b·∫£o ƒë√∫ng ƒë∆∞·ªùng d·∫´n d·ª±a tr√™n baseURL
      fetch("{{ .Site.BaseURL }}index.json")
        .then(res => {
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i index.json");
          return res.json();
        })
        .then(data => {
          pages = data;
          console.log("D·ªØ li·ªáu t·ª´ index.json (ph∆∞∆°ng ph√°p alt):", data); // G·ª° l·ªói
        })
        .catch(error => console.error("L·ªói khi t·∫£i index.json (ph∆∞∆°ng ph√°p alt):", error));

      searchInputAlt.addEventListener("input", function () {
        const query = this.value.toLowerCase().trim();
        searchResultsAlt.innerHTML = "";

        if (query.length < 2) return; // Ch·ªâ hi·ªán khi g√µ ‚â• 2 k√Ω t·ª±

        const filtered = pages.filter(p =>
          (p.title && p.title.toLowerCase().includes(query)) ||
          (p.summary && p.summary.toLowerCase().includes(query)) ||
          (p.content && p.content.toLowerCase().includes(query))
        );

        if (filtered.length === 0) {
          searchResultsAlt.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</p>";
          return;
        }

        filtered.slice(0, 8).forEach(p => {
          const item = document.createElement("a");
          item.href = p.permalink;
          item.classList.add("search-item");
          const snippet = extractSnippet(p.content || p.summary || p.description || "", query);
          item.innerHTML = `
            <strong>${p.title || "Ti√™u ƒë·ªÅ kh√¥ng c√≥"}</strong>
            <p>${snippet}</p>
            <small>Ngu·ªìn: ${p.permalink.includes("/blog/") ? "Blog" : p.permalink.includes("/profile/") ? "Profile" : "Kh√°c"}</small>
          `;
          searchResultsAlt.appendChild(item);
        });
      });
    }
  </script>
</section>
{{ end }}