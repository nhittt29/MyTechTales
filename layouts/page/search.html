{{ define "main" }}
<section class="search-page" style="padding:2rem;max-width:850px;margin:auto;">
  <h1 style="margin-bottom:1rem;">T√¨m ki·∫øm üîç</h1>
  <p>Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m b√†i vi·∫øt c√≥ ch·ª©a t·ª´ ƒë√≥</p>

  <input id="search-input" type="text" placeholder="V√≠ d·ª•: m√¥i tr∆∞·ªùng runtime, JavaScript, API..."
         style="width:100%;padding:10px;border-radius:8px;border:1px solid #bbb;margin-top:10px;">
  <div id="search-results" style="margin-top:2rem;"></div>

  <script>
    // --- T·∫£i d·ªØ li·ªáu t·ª´ index.json ---
    async function loadIndex() {
      const res = await fetch('{{ "index.json" | absURL }}');
      return await res.json();
    }

    // --- H√†m c·∫Øt ƒëo·∫°n vƒÉn ch·ª©a t·ª´ kh√≥a ---
    function extractSnippet(content, keyword) {
      if (!content) return "Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ hi·ªÉn th·ªã.";
      const regex = new RegExp(`(.{0,80})${keyword}(.{0,80})`, "gi");
      const matches = content.match(regex);
      if (!matches) {
        // N·∫øu kh√¥ng t√¨m th·∫•y kh·ªõp ch√≠nh x√°c, t√¨m t·ª´ kh√≥a trong to√†n b·ªô n·ªôi dung
        const index = content.toLowerCase().indexOf(keyword.toLowerCase());
        if (index !== -1) {
          const start = Math.max(0, index - 80);
          const end = Math.min(content.length, index + keyword.length + 80);
          return content.slice(start, end).replace(new RegExp(`(${keyword})`, "gi"), "<mark>$1</mark>") + "...";
        }
        return content.slice(0, 160) + "...";
      }
      return matches[0].replace(new RegExp(`(${keyword})`, "gi"), "<mark>$1</mark>") + "...";
    }

    // --- Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm ---
    function renderResults(results, keyword) {
      const container = document.getElementById("search-results");
      container.innerHTML = "";

      if (results.length === 0) {
        container.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o ph√π h·ª£p.</p>";
        return;
      }

      results.forEach(post => {
        const div = document.createElement("div");
        div.style.marginBottom = "1.5rem";
        const snippet = extractSnippet(post.content || post.summary, keyword);
        div.innerHTML = `
          <div style="background:#fff;border:1px solid #ddd;padding:1rem;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
            <h3><a href="${post.permalink}" style="color:#0077cc;text-decoration:none;">${post.title}</a></h3>
            <p style="color:#444;line-height:1.6;">${snippet}</p>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // --- X·ª≠ l√Ω khi nh·∫≠p t·ª´ kh√≥a ---
    document.addEventListener("DOMContentLoaded", async () => {
      const data = await loadIndex();
      const input = document.getElementById("search-input");

      input.addEventListener("input", e => {
        const keyword = e.target.value.trim().toLowerCase();
        if (!keyword) {
          document.getElementById("search-results").innerHTML = "";
          return;
        }

        const results = data.filter(post =>
          post.title.toLowerCase().includes(keyword) ||
          (post.content && post.content.toLowerCase().includes(keyword)) ||
          (post.summary && post.summary.toLowerCase().includes(keyword))
        );

        renderResults(results, keyword);
      });
    });
  </script>
</section>
{{ end }}